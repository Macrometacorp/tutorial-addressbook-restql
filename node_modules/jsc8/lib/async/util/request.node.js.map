{"version":3,"file":"request.node.js","sourceRoot":"","sources":["../../../src/util/request.node.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Agent as HttpAgent,\n  ClientRequest,\n  IncomingMessage,\n  request as httpRequest\n} from \"http\";\nimport { Agent as HttpsAgent, request as httpsRequest } from \"https\";\nimport { parse as parseUrl, Url } from \"url\";\nimport { joinPath } from \"./joinPath\";\nimport { Errback } from \"./types\";\n\nexport type C8jsResponse = IncomingMessage & {\n  body?: any;\n  host?: number;\n};\n\nexport type C8jsError = Error & {\n  request: ClientRequest;\n};\n\nexport interface RequestOptions {\n  method: string;\n  url: Url;\n  headers: { [key: string]: string };\n  body: any;\n  expectBinary: boolean;\n}\n\nexport interface RequestFunction {\n  (opts: RequestOptions, cb: Errback<C8jsResponse>): void;\n  close?: () => void;\n}\n\nexport const isBrowser = false;\n\nexport function createRequest(\n  baseUrl: string,\n  agentOptions: any,\n  agent: any\n): RequestFunction {\n  const baseUrlParts = parseUrl(baseUrl);\n  const isTls = baseUrlParts.protocol === \"https:\";\n  if (!agent) {\n    if (isTls) agent = new HttpsAgent(agentOptions);\n    else agent = new HttpAgent(agentOptions);\n  }\n  return Object.assign(\n    function request(\n      { method, url, headers, body }: RequestOptions,\n      callback: Errback<C8jsResponse>\n    ) {\n      let path = baseUrlParts.pathname\n        ? url.pathname\n          ? joinPath(baseUrlParts.pathname, url.pathname)\n          : baseUrlParts.pathname\n        : url.pathname;\n      const search = url.search\n        ? baseUrlParts.search\n          ? `${baseUrlParts.search}&${url.search.slice(1)}`\n          : url.search\n        : baseUrlParts.search;\n      if (search) path += search;\n      if (body && !headers[\"content-length\"]) {\n        headers[\"content-length\"] = String(Buffer.byteLength(body));\n      }\n      const options: any = { path, method, headers, agent };\n      options.hostname = baseUrlParts.hostname;\n      options.port = baseUrlParts.port;\n      options.auth = baseUrlParts.auth;\n      let called = false;\n      try {\n        const req = (isTls ? httpsRequest : httpRequest)(\n          options,\n          (res: IncomingMessage) => {\n            const data: Buffer[] = [];\n            res.on(\"data\", chunk => data.push(chunk as Buffer));\n            res.on(\"end\", () => {\n              const result = res as C8jsResponse;\n              result.body = Buffer.concat(data);\n              if (called) return;\n              called = true;\n              callback(null, result);\n            });\n          }\n        );\n        req.on(\"error\", err => {\n          const error = err as C8jsError;\n          error.request = req;\n          if (called) return;\n          called = true;\n          callback(err);\n        });\n        if (body) req.write(body);\n        req.end();\n      } catch (e) {\n        if (called) return;\n        called = true;\n        callback(e);\n      }\n    },\n    {\n      close() {\n        agent.destroy();\n      }\n    }\n  );\n}\n"]}